# ShieldOps Security Playbook: Critical CVE Patching
# Triggered when: Critical or high-severity CVE detected on production resources

name: cve-critical-patch
version: "1.0"
description: "Patch critical CVEs with minimal service disruption"
trigger:
  scanner_type: ["cve", "container"]
  severity: ["critical", "high"]

investigation:
  steps:
    - name: identify_affected_resources
      action: query_inventory
      description: "List all resources running the affected package/image"
      extract:
        - affected_hosts
        - affected_containers
        - affected_services

    - name: check_exploit_availability
      action: query_cve_db
      description: "Check if public exploits exist for this CVE"
      extract:
        - exploit_available
        - exploit_maturity
        - attack_vector

    - name: assess_blast_radius
      action: query_dependencies
      description: "Map service dependencies to estimate impact of patching"
      extract:
        - dependent_services
        - traffic_percentage
        - rollback_complexity

    - name: check_patch_availability
      action: query_package_registry
      description: "Verify a patched version is available"
      extract:
        - patched_version
        - changelog_url
        - breaking_changes

remediation:
  decision_tree:
    - condition: "exploit_available AND severity == 'critical'"
      action: emergency_patch
      risk_level: high
      params:
        strategy: rolling_update
        max_unavailable: "25%"
        canary_percentage: 10
        canary_duration_minutes: 15

    - condition: "patched_version_available AND no_breaking_changes"
      action: standard_patch
      risk_level: medium
      params:
        strategy: rolling_update
        max_unavailable: "10%"
        test_in_staging_first: true

    - condition: "no_patch_available"
      action: apply_workaround
      risk_level: medium
      params:
        options:
          - "network isolation of affected service"
          - "WAF rule to block known exploit vectors"
          - "disable vulnerable feature if non-critical"

    - condition: "default"
      action: schedule_maintenance_window
      risk_level: low
      params:
        window_hours: 4
        notify_stakeholders: true

validation:
  checks:
    - name: vulnerability_resolved
      description: "Re-scan to confirm CVE is no longer present"
      action: rescan_resource
      timeout_seconds: 300

    - name: service_healthy
      description: "Verify service health after patching"
      action: health_check
      expected: "all endpoints returning 200"
      timeout_seconds: 120

    - name: no_regression
      description: "Run smoke tests against patched service"
      action: run_smoke_tests
      timeout_seconds: 600

  on_failure:
    action: rollback_and_escalate
    escalation_channel: "#security-oncall"
