name: CD â€” Staging

on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    branches: [main]

concurrency:
  group: cd-staging
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  ECR_REPO: shieldops-staging
  ECS_CLUSTER: shieldops-staging-cluster
  ECS_SERVICE: shieldops-staging-service
  TASK_FAMILY: shieldops-staging-app
  CONTAINER_NAME: shieldops-app

jobs:
  build-and-push:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    outputs:
      image_uri: ${{ steps.build.outputs.image_uri }}
      image_tag: ${{ steps.meta.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate image tag
        id: meta
        run: echo "tag=sha-$(git rev-parse --short HEAD)-${{ github.run_number }}" >> "$GITHUB_OUTPUT"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        id: build
        env:
          REGISTRY: ${{ steps.ecr-login.outputs.registry }}
          TAG: ${{ steps.meta.outputs.tag }}
        run: |
          IMAGE_URI="${REGISTRY}/${ECR_REPO}:${TAG}"
          docker build -t "${IMAGE_URI}" -f infrastructure/docker/Dockerfile .
          docker push "${IMAGE_URI}"
          echo "image_uri=${IMAGE_URI}" >> "$GITHUB_OUTPUT"

  trivy-scan:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Trivy container scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ needs.build-and-push.outputs.image_uri }}
          format: table
          exit-code: 1
          severity: CRITICAL,HIGH

  deploy:
    needs: [build-and-push, trivy-scan]
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download current task definition
        run: |
          aws ecs describe-task-definition \
            --task-definition "${TASK_FAMILY}" \
            --query 'taskDefinition' \
            --output json > task-def.json

      - name: Update image in task definition
        env:
          IMAGE_URI: ${{ needs.build-and-push.outputs.image_uri }}
        run: |
          jq --arg img "${IMAGE_URI}" --arg name "${CONTAINER_NAME}" \
            '(.containerDefinitions[] | select(.name == $name)).image = $img
             | del(.taskDefinitionArn, .revision, .status, .requiresAttributes,
                   .compatibilities, .registeredAt, .registeredBy)' \
            task-def.json > new-task-def.json

      - name: Register new task definition
        id: task-def
        run: |
          ARN=$(aws ecs register-task-definition \
            --cli-input-json file://new-task-def.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
          echo "arn=${ARN}" >> "$GITHUB_OUTPUT"

      - name: Deploy to ECS
        run: |
          aws ecs update-service \
            --cluster "${ECS_CLUSTER}" \
            --service "${ECS_SERVICE}" \
            --task-definition "${{ steps.task-def.outputs.arn }}" \
            --force-new-deployment \
            --no-cli-pager

      - name: Wait for deployment stability
        run: |
          echo "Waiting for ECS service to stabilize (up to 5 minutes)..."
          aws ecs wait services-stable \
            --cluster "${ECS_CLUSTER}" \
            --services "${ECS_SERVICE}"

      - name: Verify ALB health
        env:
          HEALTH_URL: ${{ secrets.STAGING_HEALTH_URL }}
        run: |
          echo "Polling health endpoint for up to 120s..."
          for i in $(seq 1 24); do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${HEALTH_URL}" || true)
            if [ "${STATUS}" = "200" ]; then
              echo "Health check passed!"
              exit 0
            fi
            echo "Attempt ${i}/24: status=${STATUS}, retrying in 5s..."
            sleep 5
          done
          echo "Health check failed after 120s"
          exit 1
