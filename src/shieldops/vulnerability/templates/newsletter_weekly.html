<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ShieldOps Weekly Security Digest</title>
</head>
<body style="margin: 0; padding: 0; background-color: #1a1a2e; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; color: #e0e0e0;">
  <!-- Wrapper -->
  <table role="presentation" width="100%" cellpadding="0" cellspacing="0" style="background-color: #1a1a2e;">
    <tr>
      <td align="center" style="padding: 20px 0;">
        <table role="presentation" width="600" cellpadding="0" cellspacing="0" style="max-width: 600px; width: 100%;">

          <!-- Header -->
          <tr>
            <td style="background: linear-gradient(135deg, #0f3460 0%, #16213e 100%); padding: 36px 40px; border-radius: 12px 12px 0 0; text-align: center;">
              <table role="presentation" width="100%" cellpadding="0" cellspacing="0">
                <tr>
                  <td align="center">
                    <span style="font-size: 40px;">&#x1F6E1;</span>
                    <h1 style="margin: 10px 0 5px 0; font-size: 26px; color: #ffffff; font-weight: 700;">ShieldOps</h1>
                    <p style="margin: 0 0 4px 0; font-size: 15px; color: #a0c4ff; text-transform: uppercase; letter-spacing: 2px;">Weekly Security Digest</p>
                    <p style="margin: 0; font-size: 12px; color: #667788;">Comprehensive vulnerability and posture report</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>

          <!-- Period & Summary Bar -->
          <tr>
            <td style="background-color: #0f3460; padding: 16px 40px;">
              <table role="presentation" width="100%" cellpadding="0" cellspacing="0">
                <tr>
                  <td style="font-size: 13px; color: #8899aa;">
                    Week of {{ digest.period_start[:10] }} to {{ digest.period_end[:10] }}
                    {% if digest.team_id %} | Team: {{ digest.team_id }}{% endif %}
                  </td>
                  <td align="right" style="font-size: 13px; color: #8899aa;">
                    {{ digest.sections | length }} sections
                  </td>
                </tr>
              </table>
            </td>
          </tr>

          <!-- Executive Summary -->
          <tr>
            <td style="background-color: #16213e; padding: 24px 40px; border-bottom: 1px solid #0f3460;">
              <h2 style="margin: 0 0 16px 0; font-size: 16px; color: #a0c4ff; text-transform: uppercase; letter-spacing: 1px;">
                Executive Summary
              </h2>
              <table role="presentation" width="100%" cellpadding="0" cellspacing="0">
                <tr>
                  {% for section in digest.sections %}
                    {% if section.title == "New Vulnerabilities" %}
                    <td width="33%" style="text-align: center; padding: 8px;">
                      <div style="background-color: #1a2435; border-radius: 8px; padding: 16px 8px;">
                        <div style="font-size: 28px; font-weight: 700; color: #e94560;">{{ section.content.total }}</div>
                        <div style="font-size: 11px; color: #8899aa; margin-top: 4px;">New Vulns</div>
                      </div>
                    </td>
                    {% elif section.title == "SLA Status" %}
                    <td width="33%" style="text-align: center; padding: 8px;">
                      <div style="background-color: #1a2435; border-radius: 8px; padding: 16px 8px;">
                        <div style="font-size: 28px; font-weight: 700; color: {% if section.content.breached > 0 %}#dc3545{% else %}#28a745{% endif %};">{{ section.content.breached }}</div>
                        <div style="font-size: 11px; color: #8899aa; margin-top: 4px;">SLA Breaches</div>
                      </div>
                    </td>
                    {% elif section.title == "Security Posture" %}
                    <td width="33%" style="text-align: center; padding: 8px;">
                      <div style="background-color: #1a2435; border-radius: 8px; padding: 16px 8px;">
                        {% if section.content.current_score is not none %}
                          <div style="font-size: 28px; font-weight: 700; color: {% if section.content.trend == 'improving' %}#28a745{% elif section.content.trend == 'declining' %}#dc3545{% else %}#a0c4ff{% endif %};">
                            {{ section.content.current_score }}
                          </div>
                        {% else %}
                          <div style="font-size: 28px; font-weight: 700; color: #8899aa;">--</div>
                        {% endif %}
                        <div style="font-size: 11px; color: #8899aa; margin-top: 4px;">Posture Score</div>
                      </div>
                    </td>
                    {% endif %}
                  {% endfor %}
                </tr>
              </table>
            </td>
          </tr>

          <!-- Detailed Sections -->
          {% for section in digest.sections %}
          <tr>
            <td style="background-color: #16213e; padding: 24px 40px; border-bottom: 1px solid #0f3460;">

              <!-- Section Title -->
              <h2 style="margin: 0 0 16px 0; font-size: 18px; color: #ffffff; border-left: 3px solid #e94560; padding-left: 12px;">
                {{ section.title }}
              </h2>

              {% if section.title == "New Vulnerabilities" %}
                <!-- Severity Breakdown -->
                <table role="presentation" width="100%" cellpadding="0" cellspacing="0" style="margin-bottom: 16px;">
                  <tr>
                    <td style="padding: 4px 0;">
                      <span style="font-size: 28px; font-weight: 700; color: #ffffff;">{{ section.content.total }}</span>
                      <span style="font-size: 14px; color: #8899aa; margin-left: 8px;">new vulnerabilities this week</span>
                    </td>
                  </tr>
                  <tr>
                    <td style="padding: 12px 0;">
                      {% for sev, count in section.content.by_severity.items() %}
                        {% if sev == "critical" %}
                          <span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background-color: #dc3545; color: #ffffff; margin-right: 6px; margin-bottom: 4px;">CRITICAL: {{ count }}</span>
                        {% elif sev == "high" %}
                          <span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background-color: #e8850c; color: #ffffff; margin-right: 6px; margin-bottom: 4px;">HIGH: {{ count }}</span>
                        {% elif sev == "medium" %}
                          <span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background-color: #c4a800; color: #1a1a2e; margin-right: 6px; margin-bottom: 4px;">MEDIUM: {{ count }}</span>
                        {% elif sev == "low" %}
                          <span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background-color: #28a745; color: #ffffff; margin-right: 6px; margin-bottom: 4px;">LOW: {{ count }}</span>
                        {% else %}
                          <span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background-color: #6c757d; color: #ffffff; margin-right: 6px; margin-bottom: 4px;">{{ sev | upper }}: {{ count }}</span>
                        {% endif %}
                      {% endfor %}
                    </td>
                  </tr>
                </table>

                <!-- Severity Distribution Bar -->
                {% set total = section.content.total if section.content.total > 0 else 1 %}
                <table role="presentation" width="100%" cellpadding="0" cellspacing="0" style="margin-bottom: 16px;">
                  <tr>
                    <td>
                      <div style="display: flex; height: 8px; border-radius: 4px; overflow: hidden; background-color: #1a1a2e;">
                        {% if section.content.by_severity.get("critical", 0) > 0 %}
                        <div style="width: {{ (section.content.by_severity.get("critical", 0) / total * 100) | int }}%; background-color: #dc3545; height: 8px; display: inline-block;"></div>
                        {% endif %}
                        {% if section.content.by_severity.get("high", 0) > 0 %}
                        <div style="width: {{ (section.content.by_severity.get("high", 0) / total * 100) | int }}%; background-color: #e8850c; height: 8px; display: inline-block;"></div>
                        {% endif %}
                        {% if section.content.by_severity.get("medium", 0) > 0 %}
                        <div style="width: {{ (section.content.by_severity.get("medium", 0) / total * 100) | int }}%; background-color: #c4a800; height: 8px; display: inline-block;"></div>
                        {% endif %}
                        {% if section.content.by_severity.get("low", 0) > 0 %}
                        <div style="width: {{ (section.content.by_severity.get("low", 0) / total * 100) | int }}%; background-color: #28a745; height: 8px; display: inline-block;"></div>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                </table>

                <!-- Vulnerability Table -->
                {% if section.content.vulnerabilities %}
                <table role="presentation" width="100%" cellpadding="0" cellspacing="0" style="font-size: 13px;">
                  <tr>
                    <td style="padding: 8px 0; color: #8899aa; border-bottom: 1px solid #0f3460; font-weight: 600; width: 25%;">CVE</td>
                    <td style="padding: 8px 0; color: #8899aa; border-bottom: 1px solid #0f3460; font-weight: 600; width: 15%;">Severity</td>
                    <td style="padding: 8px 0; color: #8899aa; border-bottom: 1px solid #0f3460; font-weight: 600; width: 15%;">Status</td>
                    <td style="padding: 8px 0; color: #8899aa; border-bottom: 1px solid #0f3460; font-weight: 600;">Description</td>
                  </tr>
                  {% for vuln in section.content.vulnerabilities[:15] %}
                  <tr>
                    <td style="padding: 6px 0; border-bottom: 1px solid #1a1a2e; color: #a0c4ff; font-family: monospace; font-size: 12px;">{{ vuln.cve_id or vuln.id }}</td>
                    <td style="padding: 6px 0; border-bottom: 1px solid #1a1a2e;">
                      {% if vuln.severity == "critical" %}
                        <span style="color: #dc3545; font-weight: 600;">&#9679; Critical</span>
                      {% elif vuln.severity == "high" %}
                        <span style="color: #e8850c; font-weight: 600;">&#9679; High</span>
                      {% elif vuln.severity == "medium" %}
                        <span style="color: #c4a800; font-weight: 600;">&#9679; Medium</span>
                      {% else %}
                        <span style="color: #28a745; font-weight: 600;">&#9679; Low</span>
                      {% endif %}
                    </td>
                    <td style="padding: 6px 0; border-bottom: 1px solid #1a1a2e; color: #8899aa; font-size: 12px;">{{ vuln.status }}</td>
                    <td style="padding: 6px 0; border-bottom: 1px solid #1a1a2e; color: #cccccc;">{{ vuln.title[:80] }}</td>
                  </tr>
                  {% endfor %}
                </table>
                {% if section.content.total > 15 %}
                <p style="margin: 12px 0 0 0; font-size: 12px; color: #8899aa;">
                  ... and {{ section.content.total - 15 }} more. View all in the ShieldOps dashboard.
                </p>
                {% endif %}
                {% endif %}

              {% elif section.title == "SLA Status" %}
                <!-- SLA Breach Highlight -->
                <table role="presentation" width="100%" cellpadding="0" cellspacing="0">
                  <tr>
                    <td width="50%" style="padding: 8px;">
                      <div style="padding: 16px; background-color: {% if section.content.breached > 0 %}#3d1520{% else %}#1a2e1a{% endif %}; border-radius: 8px; text-align: center;">
                        <div style="font-size: 36px; font-weight: 700; color: {% if section.content.breached > 0 %}#dc3545{% else %}#28a745{% endif %};">{{ section.content.breached }}</div>
                        <div style="font-size: 12px; color: #cccccc; margin-top: 4px;">Active SLA Breaches</div>
                      </div>
                    </td>
                    <td width="50%" style="padding: 8px;">
                      <div style="padding: 16px; background-color: #1a2435; border-radius: 8px; text-align: center;">
                        <div style="font-size: 36px; font-weight: 700; color: #e8850c;">{{ section.content.get("approaching", 0) }}</div>
                        <div style="font-size: 12px; color: #cccccc; margin-top: 4px;">Approaching Deadline</div>
                      </div>
                    </td>
                  </tr>
                </table>
                {% if section.content.breached_vulns %}
                <table role="presentation" width="100%" cellpadding="0" cellspacing="0" style="margin-top: 12px; font-size: 13px;">
                  <tr>
                    <td style="padding: 8px 0; color: #8899aa; border-bottom: 1px solid #0f3460; font-weight: 600;">CVE</td>
                    <td style="padding: 8px 0; color: #8899aa; border-bottom: 1px solid #0f3460; font-weight: 600;">Severity</td>
                    <td style="padding: 8px 0; color: #8899aa; border-bottom: 1px solid #0f3460; font-weight: 600;">SLA Due</td>
                  </tr>
                  {% for vuln in section.content.breached_vulns[:10] %}
                  <tr>
                    <td style="padding: 6px 0; border-bottom: 1px solid #1a1a2e; color: #a0c4ff; font-family: monospace; font-size: 12px;">{{ vuln.cve_id or vuln.id }}</td>
                    <td style="padding: 6px 0; border-bottom: 1px solid #1a1a2e; color: #dc3545;">{{ vuln.severity }}</td>
                    <td style="padding: 6px 0; border-bottom: 1px solid #1a1a2e; color: #8899aa;">{{ vuln.sla_due_at[:10] if vuln.sla_due_at else "N/A" }}</td>
                  </tr>
                  {% endfor %}
                </table>
                {% endif %}

              {% elif section.title == "Remediation Progress" %}
                <!-- Remediation Stats Grid -->
                <table role="presentation" width="100%" cellpadding="0" cellspacing="0">
                  <tr>
                    <td width="20%" style="text-align: center; padding: 12px 4px;">
                      <div style="background-color: #1a2435; border-radius: 8px; padding: 14px 4px;">
                        <div style="font-size: 24px; font-weight: 700; color: #e94560;">{{ section.content.total_open }}</div>
                        <div style="font-size: 10px; color: #8899aa; margin-top: 4px;">Open</div>
                      </div>
                    </td>
                    <td width="20%" style="text-align: center; padding: 12px 4px;">
                      <div style="background-color: #1a2435; border-radius: 8px; padding: 14px 4px;">
                        <div style="font-size: 24px; font-weight: 700; color: #a0c4ff;">{{ section.content.remediated }}</div>
                        <div style="font-size: 10px; color: #8899aa; margin-top: 4px;">Remediated</div>
                      </div>
                    </td>
                    <td width="20%" style="text-align: center; padding: 12px 4px;">
                      <div style="background-color: #1a2435; border-radius: 8px; padding: 14px 4px;">
                        <div style="font-size: 24px; font-weight: 700; color: #28a745;">{{ section.content.verified }}</div>
                        <div style="font-size: 10px; color: #8899aa; margin-top: 4px;">Verified</div>
                      </div>
                    </td>
                    <td width="20%" style="text-align: center; padding: 12px 4px;">
                      <div style="background-color: #1a2435; border-radius: 8px; padding: 14px 4px;">
                        <div style="font-size: 24px; font-weight: 700; color: #6c757d;">{{ section.content.closed }}</div>
                        <div style="font-size: 10px; color: #8899aa; margin-top: 4px;">Closed</div>
                      </div>
                    </td>
                    <td width="20%" style="text-align: center; padding: 12px 4px;">
                      <div style="background-color: #1a2435; border-radius: 8px; padding: 14px 4px;">
                        <div style="font-size: 24px; font-weight: 700; color: #c4a800;">{{ section.content.accepted_risk }}</div>
                        <div style="font-size: 10px; color: #8899aa; margin-top: 4px;">Risk Accepted</div>
                      </div>
                    </td>
                  </tr>
                </table>

                {% if section.content.mttr_hours %}
                <table role="presentation" width="100%" cellpadding="0" cellspacing="0" style="margin-top: 12px;">
                  <tr>
                    <td style="padding: 12px 16px; background-color: #1a2435; border-radius: 8px;">
                      <span style="font-size: 13px; color: #8899aa;">Mean Time to Remediate (MTTR):</span>
                      <span style="font-size: 18px; font-weight: 700; color: #a0c4ff; margin-left: 8px;">{{ section.content.mttr_hours }}h</span>
                    </td>
                  </tr>
                </table>
                {% endif %}

                <!-- Trend Chart Placeholder -->
                <table role="presentation" width="100%" cellpadding="0" cellspacing="0" style="margin-top: 12px;">
                  <tr>
                    <td style="padding: 20px 16px; background-color: #1a2435; border-radius: 8px; text-align: center;">
                      <p style="margin: 0; font-size: 12px; color: #556677;">
                        [Remediation trend chart available in the ShieldOps dashboard]
                      </p>
                    </td>
                  </tr>
                </table>

              {% elif section.title == "Security Posture" %}
                <!-- Posture Score Card -->
                <table role="presentation" width="100%" cellpadding="0" cellspacing="0">
                  <tr>
                    <td width="50%" style="padding: 8px;">
                      <div style="padding: 20px 16px; background-color: #1a2435; border-radius: 8px; text-align: center;">
                        {% if section.content.current_score is not none %}
                          <div style="font-size: 44px; font-weight: 700; color: {% if section.content.trend == 'improving' %}#28a745{% elif section.content.trend == 'declining' %}#dc3545{% else %}#a0c4ff{% endif %};">
                            {{ section.content.current_score }}
                          </div>
                          <div style="font-size: 12px; color: #8899aa; margin-top: 4px;">Current Score (out of 100)</div>
                        {% else %}
                          <div style="font-size: 24px; color: #8899aa;">--</div>
                          <div style="font-size: 12px; color: #556677; margin-top: 4px;">No data available</div>
                        {% endif %}
                      </div>
                    </td>
                    <td width="50%" style="padding: 8px;">
                      <div style="padding: 20px 16px; background-color: #1a2435; border-radius: 8px; text-align: center;">
                        {% if section.content.delta is not none %}
                          <div style="font-size: 32px; font-weight: 700; color: {% if section.content.delta > 0 %}#28a745{% elif section.content.delta < 0 %}#dc3545{% else %}#8899aa{% endif %};">
                            {% if section.content.delta > 0 %}&#9650; +{{ section.content.delta }}{% elif section.content.delta < 0 %}&#9660; {{ section.content.delta }}{% else %}&#8212;{% endif %}
                          </div>
                          <div style="font-size: 12px; color: #8899aa; margin-top: 4px;">Change this week</div>
                        {% else %}
                          <div style="font-size: 24px; color: #8899aa;">--</div>
                          <div style="font-size: 12px; color: #556677; margin-top: 4px;">No comparison data</div>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                </table>

                <table role="presentation" width="100%" cellpadding="0" cellspacing="0" style="margin-top: 8px;">
                  <tr>
                    <td style="padding: 12px 16px; background-color: #1a2435; border-radius: 8px;">
                      <span style="font-size: 13px; color: #8899aa;">Trend:</span>
                      <span style="font-size: 13px; font-weight: 600; margin-left: 8px; color: {% if section.content.trend == 'improving' %}#28a745{% elif section.content.trend == 'declining' %}#dc3545{% else %}#a0c4ff{% endif %};">
                        {{ section.content.trend | capitalize }}
                      </span>
                      <span style="font-size: 12px; color: #556677; margin-left: 12px;">({{ section.content.scan_count }} scans analyzed)</span>
                    </td>
                  </tr>
                </table>

                <!-- Posture Trend Chart Placeholder -->
                <table role="presentation" width="100%" cellpadding="0" cellspacing="0" style="margin-top: 12px;">
                  <tr>
                    <td style="padding: 20px 16px; background-color: #1a2435; border-radius: 8px; text-align: center;">
                      <p style="margin: 0; font-size: 12px; color: #556677;">
                        [Posture trend chart available in the ShieldOps dashboard]
                      </p>
                    </td>
                  </tr>
                </table>

              {% elif section.title == "Top Risks" %}
                <!-- Top Risks -->
                <p style="margin: 0 0 12px 0; font-size: 13px; color: #8899aa;">
                  Critical vulnerabilities requiring immediate attention:
                </p>
                {% for risk in section.content.risks[:5] %}
                <table role="presentation" width="100%" cellpadding="0" cellspacing="0" style="margin-bottom: 10px;">
                  <tr>
                    <td style="padding: 14px 16px; background-color: #2a1525; border-radius: 8px; border-left: 4px solid #dc3545;">
                      <table role="presentation" width="100%" cellpadding="0" cellspacing="0">
                        <tr>
                          <td>
                            <span style="font-size: 14px; font-weight: 700; color: #ffffff;">{{ risk.cve_id or risk.id }}</span>
                            <span style="display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; background-color: #dc3545; color: #ffffff; margin-left: 8px; vertical-align: middle;">{{ risk.severity | upper }}</span>
                          </td>
                          <td align="right">
                            <span style="font-size: 12px; color: #e8850c; font-weight: 600;">{{ risk.days_open }}d open</span>
                          </td>
                        </tr>
                      </table>
                      <div style="font-size: 13px; color: #cccccc; margin-top: 8px; line-height: 1.4;">{{ risk.description[:180] }}</div>
                      {% if risk.affected_resource %}
                      <div style="font-size: 12px; color: #8899aa; margin-top: 6px;">
                        Resource: <span style="color: #a0c4ff; font-family: monospace;">{{ risk.affected_resource }}</span>
                      </div>
                      {% endif %}
                    </td>
                  </tr>
                </table>
                {% endfor %}

              {% else %}
                <!-- Generic Section -->
                <table role="presentation" width="100%" cellpadding="0" cellspacing="0">
                  {% for key, value in section.content.items() %}
                  <tr>
                    <td style="padding: 6px 0; font-size: 13px; color: #8899aa; width: 35%;">{{ key }}:</td>
                    <td style="padding: 6px 0; font-size: 13px; color: #cccccc;">{{ value }}</td>
                  </tr>
                  {% endfor %}
                </table>
              {% endif %}
            </td>
          </tr>
          {% endfor %}

          <!-- Footer -->
          <tr>
            <td style="background-color: #0f3460; padding: 28px 40px; border-radius: 0 0 12px 12px; text-align: center;">
              <p style="margin: 0 0 4px 0; font-size: 13px; color: #a0c4ff; font-weight: 600;">
                ShieldOps Security Platform
              </p>
              <p style="margin: 0 0 12px 0; font-size: 12px; color: #8899aa;">
                Generated {{ digest.generated_at[:19] }} UTC
              </p>
              <p style="margin: 0; font-size: 11px; color: #556677;">
                To adjust newsletter preferences or view detailed reports, visit your ShieldOps dashboard.
                <br>
                This report was automatically generated. Do not reply to this email.
              </p>
            </td>
          </tr>

        </table>
      </td>
    </tr>
  </table>
</body>
</html>
