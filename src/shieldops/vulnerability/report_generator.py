"""Automated security report generation.

Generates executive, compliance, and vulnerability reports in HTML
format using Jinja2 templates, with data sourced from the PostureAggregator.
"""

from __future__ import annotations

from datetime import UTC, datetime
from typing import Any

import structlog
from pydantic import BaseModel, Field

logger = structlog.get_logger()


class ReportMetadata(BaseModel):
    """Metadata for a generated report."""

    report_id: str
    report_type: str
    title: str
    generated_at: str = Field(default_factory=lambda: datetime.now(UTC).isoformat())
    generated_by: str = "ShieldOps Security Platform"
    period_start: str = ""
    period_end: str = ""
    format: str = "html"


class SecurityReport(BaseModel):
    """A generated security report."""

    metadata: ReportMetadata
    content: str = ""
    summary: dict[str, Any] = Field(default_factory=dict)
    sections: list[dict[str, Any]] = Field(default_factory=list)


class SecurityReportGenerator:
    """Generates security reports from posture and vulnerability data.

    Args:
        posture_aggregator: PostureAggregator for sourcing data.
        repository: Optional DB repository for historical data.
    """

    def __init__(
        self,
        posture_aggregator: Any | None = None,
        repository: Any | None = None,
    ) -> None:
        self._posture = posture_aggregator
        self._repository = repository
        self._history: list[ReportMetadata] = []

    async def generate_executive_report(self) -> SecurityReport:
        """Generate an executive summary report for board/leadership."""
        from uuid import uuid4

        report_id = f"exec-{uuid4().hex[:8]}"

        overview = {}
        trends = {}
        risk_matrix = {}

        if self._posture:
            overview = await self._posture.get_overview()
            trends = await self._posture.get_trends(days=30)
            risk_matrix = await self._posture.get_risk_matrix()

        summary = {
            "overall_score": overview.get("overall_score", 0),
            "grade": overview.get("grade", "N/A"),
            "total_vulnerabilities": overview.get("total_vulnerabilities", 0),
            "critical_count": overview.get("open_critical", 0),
            "high_count": overview.get("open_high", 0),
            "mttr_hours": overview.get("mean_time_to_remediate_hours", 0),
            "sla_breaches": overview.get("sla_breaches", 0),
            "patch_coverage": overview.get("patch_coverage", 0),
        }

        sections = [
            {
                "title": "Security Posture Overview",
                "type": "overview",
                "data": overview,
            },
            {
                "title": "Vulnerability Trends (30 Days)",
                "type": "trends",
                "data": trends,
            },
            {
                "title": "Risk Matrix",
                "type": "risk_matrix",
                "data": risk_matrix,
            },
        ]

        content = self._render_executive_html(summary, sections)

        metadata = ReportMetadata(
            report_id=report_id,
            report_type="executive",
            title="Executive Security Summary",
        )
        self._history.append(metadata)

        return SecurityReport(
            metadata=metadata,
            content=content,
            summary=summary,
            sections=sections,
        )

    async def generate_compliance_report(self, framework: str = "soc2") -> SecurityReport:
        """Generate a compliance report for a specific framework."""
        from uuid import uuid4

        report_id = f"comp-{uuid4().hex[:8]}"

        overview = {}
        if self._posture:
            overview = await self._posture.get_overview()

        compliance_data: dict[str, Any] = {
            "framework": framework,
            "overall_score": overview.get("overall_score", 0),
            "controls_assessed": 0,
            "controls_passing": 0,
            "controls_failing": 0,
        }

        sections = [
            {
                "title": f"{framework.upper()} Compliance Assessment",
                "type": "compliance",
                "data": compliance_data,
            },
            {
                "title": "Security Posture",
                "type": "overview",
                "data": overview,
            },
        ]

        content = self._render_compliance_html(framework, compliance_data, sections)

        metadata = ReportMetadata(
            report_id=report_id,
            report_type="compliance",
            title=f"{framework.upper()} Compliance Report",
        )
        self._history.append(metadata)

        return SecurityReport(
            metadata=metadata,
            content=content,
            summary=compliance_data,
            sections=sections,
        )

    async def generate_vulnerability_report(self) -> SecurityReport:
        """Generate a detailed vulnerability report."""
        from uuid import uuid4

        report_id = f"vuln-{uuid4().hex[:8]}"

        overview: dict[str, Any] = {}
        if self._posture:
            overview = await self._posture.get_overview()

        vulns: list[dict[str, Any]] = []
        if self._repository:
            try:
                vulns = await self._repository.list_vulnerabilities(limit=200)
            except Exception as e:
                logger.warning("vuln_report_data_failed", error=str(e))

        summary = {
            "total_vulnerabilities": len(vulns),
            "critical": sum(1 for v in vulns if v.get("severity") == "critical"),
            "high": sum(1 for v in vulns if v.get("severity") == "high"),
            "medium": sum(1 for v in vulns if v.get("severity") == "medium"),
            "low": sum(1 for v in vulns if v.get("severity") == "low"),
            "with_patches": sum(1 for v in vulns if v.get("fixed_version")),
            "overall_score": overview.get("overall_score", 0),
        }

        sections: list[dict[str, Any]] = [
            {
                "title": "Vulnerability Summary",
                "type": "summary",
                "data": summary,
            },
            {
                "title": "Critical Vulnerabilities",
                "type": "vuln_list",
                "data": [v for v in vulns if v.get("severity") == "critical"][:20],
            },
            {
                "title": "High Vulnerabilities",
                "type": "vuln_list",
                "data": [v for v in vulns if v.get("severity") == "high"][:30],
            },
        ]

        content = self._render_vulnerability_html(summary, sections, vulns)

        metadata = ReportMetadata(
            report_id=report_id,
            report_type="vulnerability",
            title="Vulnerability Assessment Report",
        )
        self._history.append(metadata)

        return SecurityReport(
            metadata=metadata,
            content=content,
            summary=summary,
            sections=sections,
        )

    def get_history(self) -> list[dict[str, Any]]:
        """Return metadata for all previously generated reports."""
        return [m.model_dump() for m in self._history]

    def _render_executive_html(
        self, summary: dict[str, Any], sections: list[dict[str, Any]]
    ) -> str:
        return (
            "<!DOCTYPE html><html><head>"
            "<title>Executive Security Summary</title>"
            "<style>body{font-family:Arial,sans-serif;margin:2em}"
            "h1{color:#1a1a2e}h2{color:#16213e}.score{font-size:2em;font-weight:bold}"
            ".grade-A{color:#27ae60}.grade-B{color:#2ecc71}.grade-C{color:#f1c40f}"
            ".grade-D{color:#e67e22}.grade-F{color:#e74c3c}"
            "table{border-collapse:collapse;width:100%}th,td{border:1px solid #ddd;padding:8px}"
            "th{background:#f8f9fa}</style></head><body>"
            f"<h1>ShieldOps Executive Security Summary</h1>"
            f"<p>Generated: {datetime.now(UTC).strftime('%Y-%m-%d %H:%M UTC')}</p>"
            f"<div class='score grade-{summary.get('grade', 'F')}'>"
            f"Score: {summary.get('overall_score', 0)}/100 ({summary.get('grade', 'N/A')})</div>"
            f"<h2>Key Metrics</h2><table><tr><th>Metric</th><th>Value</th></tr>"
            f"<tr><td>Total Vulnerabilities</td>"
            f"<td>{summary.get('total_vulnerabilities', 0)}</td></tr>"
            f"<tr><td>Critical</td><td>{summary.get('critical_count', 0)}</td></tr>"
            f"<tr><td>High</td><td>{summary.get('high_count', 0)}</td></tr>"
            f"<tr><td>MTTR (hours)</td><td>{summary.get('mttr_hours', 0)}</td></tr>"
            f"<tr><td>SLA Breaches</td><td>{summary.get('sla_breaches', 0)}</td></tr>"
            f"<tr><td>Patch Coverage</td><td>{summary.get('patch_coverage', 0)}%</td></tr>"
            "</table></body></html>"
        )

    def _render_compliance_html(
        self, framework: str, data: dict[str, Any], sections: list[dict[str, Any]]
    ) -> str:
        return (
            "<!DOCTYPE html><html><head>"
            f"<title>{framework.upper()} Compliance Report</title>"
            "<style>body{font-family:Arial,sans-serif;margin:2em}"
            "h1{color:#1a1a2e}table{border-collapse:collapse;width:100%}"
            "th,td{border:1px solid #ddd;padding:8px}th{background:#f8f9fa}</style></head><body>"
            f"<h1>{framework.upper()} Compliance Report</h1>"
            f"<p>Generated: {datetime.now(UTC).strftime('%Y-%m-%d %H:%M UTC')}</p>"
            f"<p>Security Score: {data.get('overall_score', 0)}/100</p>"
            "</body></html>"
        )

    def _render_vulnerability_html(
        self,
        summary: dict[str, Any],
        sections: list[dict[str, Any]],
        vulns: list[dict[str, Any]],
    ) -> str:
        rows = ""
        for v in vulns[:50]:
            rows += (
                f"<tr><td>{v.get('cve_id', '')}</td>"
                f"<td>{v.get('severity', '')}</td>"
                f"<td>{v.get('cvss_score', 0)}</td>"
                f"<td>{v.get('package_name', '')}</td>"
                f"<td>{v.get('status', 'open')}</td>"
                f"<td>{v.get('fixed_version', 'N/A')}</td></tr>"
            )

        return (
            "<!DOCTYPE html><html><head>"
            "<title>Vulnerability Assessment Report</title>"
            "<style>body{font-family:Arial,sans-serif;margin:2em}"
            "h1{color:#1a1a2e}table{border-collapse:collapse;width:100%}"
            "th,td{border:1px solid #ddd;padding:8px}th{background:#f8f9fa}"
            ".critical{color:#e74c3c}.high{color:#e67e22}</style></head><body>"
            f"<h1>Vulnerability Assessment Report</h1>"
            f"<p>Generated: {datetime.now(UTC).strftime('%Y-%m-%d %H:%M UTC')}</p>"
            f"<p>Total: {summary.get('total_vulnerabilities', 0)} | "
            f"Critical: {summary.get('critical', 0)} | "
            f"High: {summary.get('high', 0)} | "
            f"Medium: {summary.get('medium', 0)} | "
            f"Low: {summary.get('low', 0)}</p>"
            "<table><tr><th>CVE</th><th>Severity</th><th>CVSS</th>"
            f"<th>Package</th><th>Status</th><th>Fix Version</th></tr>{rows}</table>"
            "</body></html>"
        )
