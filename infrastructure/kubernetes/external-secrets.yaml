# ExternalSecret CRD â€” replaces the hardcoded REPLACE_ME values in secret.yaml
# by pulling secrets from AWS Secrets Manager at runtime.
#
# Prerequisites:
#   1. Install the External Secrets Operator:
#      helm install external-secrets external-secrets/external-secrets -n external-secrets --create-namespace
#   2. Create the SecretStore (below) with IAM role that has secretsmanager:GetSecretValue
#   3. Store secrets in AWS Secrets Manager under "shieldops/production"

apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: aws-secret-store
  namespace: shieldops
  labels:
    app: shieldops
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      auth:
        jwt:
          serviceAccountRef:
            name: shieldops-api
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: shieldops-secrets
  namespace: shieldops
  labels:
    app: shieldops
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secret-store
    kind: SecretStore
  target:
    name: shieldops-secrets
    creationPolicy: Owner
  data:
    - secretKey: SHIELDOPS_DATABASE_URL
      remoteRef:
        key: shieldops/production
        property: database_url

    - secretKey: SHIELDOPS_REDIS_URL
      remoteRef:
        key: shieldops/production
        property: redis_url

    - secretKey: ANTHROPIC_API_KEY
      remoteRef:
        key: shieldops/production
        property: anthropic_api_key

    - secretKey: OPENAI_API_KEY
      remoteRef:
        key: shieldops/production
        property: openai_api_key

    - secretKey: LANGSMITH_API_KEY
      remoteRef:
        key: shieldops/production
        property: langsmith_api_key

    - secretKey: SHIELDOPS_JWT_SECRET
      remoteRef:
        key: shieldops/production
        property: jwt_secret
