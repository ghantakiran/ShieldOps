"""Add vulnerability management tables.

Revision ID: 007_vuln_mgmt
Revises: 006
Create Date: 2026-02-19
"""

import sqlalchemy as sa
from sqlalchemy.dialects.postgresql import JSONB

from alembic import op

revision = "007_vuln_mgmt"
down_revision = "006"
branch_labels = None
depends_on = None


def upgrade() -> None:
    # Teams table
    op.create_table(
        "teams",
        sa.Column("id", sa.String(64), primary_key=True),
        sa.Column("name", sa.String(256), nullable=False, unique=True),
        sa.Column("description", sa.Text, default=""),
        sa.Column("slack_channel", sa.String(128), default=""),
        sa.Column("pagerduty_service_id", sa.String(128), default=""),
        sa.Column("email", sa.String(256), default=""),
        sa.Column("created_at", sa.DateTime(timezone=True), server_default=sa.func.now()),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.func.now(),
            onupdate=sa.func.now(),
        ),
    )

    # Team members
    op.create_table(
        "team_members",
        sa.Column("id", sa.String(64), primary_key=True),
        sa.Column(
            "team_id", sa.String(64), sa.ForeignKey("teams.id", ondelete="CASCADE"), nullable=False
        ),
        sa.Column(
            "user_id", sa.String(64), sa.ForeignKey("users.id", ondelete="CASCADE"), nullable=False
        ),
        sa.Column("role", sa.String(32), default="member"),  # lead, member
        sa.Column("created_at", sa.DateTime(timezone=True), server_default=sa.func.now()),
    )
    op.create_index("ix_team_members_team", "team_members", ["team_id"])
    op.create_index("ix_team_members_user", "team_members", ["user_id"])
    op.create_unique_constraint("uq_team_members_team_user", "team_members", ["team_id", "user_id"])

    # Vulnerabilities table - lifecycle managed
    op.create_table(
        "vulnerabilities",
        sa.Column("id", sa.String(64), primary_key=True),
        sa.Column("cve_id", sa.String(64), index=True),
        sa.Column("scan_id", sa.String(64), index=True),
        sa.Column(
            "source", sa.String(32), nullable=False
        ),  # trivy, nvd, gitleaks, checkov, network, k8s
        sa.Column("scanner_type", sa.String(32), nullable=False, index=True),
        sa.Column("severity", sa.String(16), nullable=False, index=True),
        sa.Column("cvss_score", sa.Float, default=0.0),
        sa.Column("title", sa.Text, default=""),
        sa.Column("description", sa.Text, default=""),
        sa.Column("package_name", sa.String(256), default=""),
        sa.Column("affected_resource", sa.String(512), nullable=False),
        sa.Column("status", sa.String(32), default="new", nullable=False, index=True),
        sa.Column("assigned_team_id", sa.String(64), sa.ForeignKey("teams.id"), nullable=True),
        sa.Column("assigned_user_id", sa.String(64), sa.ForeignKey("users.id"), nullable=True),
        sa.Column("sla_due_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("sla_breached", sa.Boolean, default=False, index=True),
        sa.Column("first_seen_at", sa.DateTime(timezone=True), server_default=sa.func.now()),
        sa.Column("last_seen_at", sa.DateTime(timezone=True), server_default=sa.func.now()),
        sa.Column("remediated_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("closed_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("remediation_steps", JSONB, default=list),
        sa.Column("scan_metadata", JSONB, default=dict),
        sa.Column("created_at", sa.DateTime(timezone=True), server_default=sa.func.now()),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.func.now(),
            onupdate=sa.func.now(),
        ),
    )
    op.create_index("ix_vulns_cve_resource", "vulnerabilities", ["cve_id", "affected_resource"])
    op.create_index("ix_vulns_status_severity", "vulnerabilities", ["status", "severity"])
    op.create_index("ix_vulns_team", "vulnerabilities", ["assigned_team_id"])
    op.create_index("ix_vulns_sla", "vulnerabilities", ["sla_breached", "sla_due_at"])

    # Vulnerability comments
    op.create_table(
        "vulnerability_comments",
        sa.Column("id", sa.String(64), primary_key=True),
        sa.Column(
            "vulnerability_id",
            sa.String(64),
            sa.ForeignKey("vulnerabilities.id", ondelete="CASCADE"),
            nullable=False,
        ),
        sa.Column("user_id", sa.String(64), sa.ForeignKey("users.id"), nullable=True),
        sa.Column("content", sa.Text, nullable=False),
        sa.Column(
            "comment_type", sa.String(32), default="comment"
        ),  # comment, status_change, assignment
        sa.Column("metadata", JSONB, default=dict),
        sa.Column("created_at", sa.DateTime(timezone=True), server_default=sa.func.now()),
    )
    op.create_index("ix_vuln_comments_vuln", "vulnerability_comments", ["vulnerability_id"])

    # Risk acceptance records
    op.create_table(
        "vulnerability_risk_acceptances",
        sa.Column("id", sa.String(64), primary_key=True),
        sa.Column(
            "vulnerability_id",
            sa.String(64),
            sa.ForeignKey("vulnerabilities.id", ondelete="CASCADE"),
            nullable=False,
        ),
        sa.Column("accepted_by", sa.String(64), sa.ForeignKey("users.id"), nullable=False),
        sa.Column("reason", sa.Text, nullable=False),
        sa.Column("expires_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("approved_by", sa.String(64), sa.ForeignKey("users.id"), nullable=True),
        sa.Column("created_at", sa.DateTime(timezone=True), server_default=sa.func.now()),
    )
    op.create_index("ix_risk_accept_vuln", "vulnerability_risk_acceptances", ["vulnerability_id"])


def downgrade() -> None:
    op.drop_table("vulnerability_risk_acceptances")
    op.drop_table("vulnerability_comments")
    op.drop_table("vulnerabilities")
    op.drop_table("team_members")
    op.drop_table("teams")
